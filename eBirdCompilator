import streamlit as st
import pandas as pd
import requests
from bs4 import BeautifulSoup

# Configuration de la page
st.set_page_config(page_title="eBirdCompilator", page_icon="üê¶", layout="centered")

# Style CSS pour personnaliser l'apparence
st.markdown("""
    <style>
    .main { text-align: center; }
    .stButton>button { width: 100%; border-radius: 20px; height: 3em; background-color: #2e7d32; color: white; }
    </style>
    """, unsafe_allow_html=True)

st.title("üê¶ eBirdCompilator")
st.subheader("Transformez vos listes eBird en fichiers CSV (Fran√ßais/Latin)")
st.write("Collez le lien de votre liste d'observation ci-dessous pour extraire les donn√©es.")

# Champ de saisie
url_input = st.text_input("Lien de la liste eBird", placeholder="https://ebird.org/checklist/S...")

if url_input:
    try:
        # On force la langue fran√ßaise via le param√®tre d'URL ?lang=fr
        url_fr = url_input.split('?')[0] + "?lang=fr"
        
        headers = {"User-Agent": "Mozilla/5.0"}
        response = requests.get(url_fr, headers=headers)
        soup = BeautifulSoup(response.text, 'html.parser')

        # Extraction de la date
        date_val = "Date inconnue"
        time_tag = soup.find('time')
        if time_tag:
            date_val = time_tag.get_text().strip()

        # Extraction des esp√®ces
        species_data = []
        observations = soup.find_all('li', class_='Observation')

        for obs in observations:
            # Nom fran√ßais
            common_name = obs.find('span', class_='Heading-main').get_text().strip()
            
            # Nom scientifique (Latin)
            sci_tag = obs.find('em', class_='sci')
            sci_name = sci_tag.get_text().strip() if sci_tag else ""
            
            # Nombre d'individus
            count_tag = obs.find('span', class_='Observation-number')
            count = count_tag.get_text().strip() if count_tag else "1"

            species_data.append({
                "Date": date_val,
                "Nom en fran√ßais": common_name,
                "Nom scientifique": sci_name,
                "Nombre": count
            })

        if species_data:
            df = pd.DataFrame(species_data)
            
            # Affichage d'un aper√ßu
            st.success(f"‚úÖ {len(df)} esp√®ces trouv√©es !")
            st.dataframe(df, use_container_width=True)

            # Bouton de t√©l√©chargement
            csv = df.to_csv(index=False, encoding='utf-8-sig')
            st.download_button(
                label="üì• T√©l√©charger le fichier CSV",
                data=csv,
                file_name=f"ebird_export_{date_val.replace(' ', '_')}.csv",
                mime="text/csv",
            )
        else:
            st.error("Aucune donn√©e trouv√©e. V√©rifiez que la liste est publique.")

    except Exception as e:
        st.error(f"Erreur lors de l'extraction : {e}")

st.markdown("---")
st.caption("eBirdCompilator - Un outil simple pour les ornithologues.")
